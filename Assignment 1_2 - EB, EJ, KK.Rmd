---
title: "Assignment 1 & 2"
author: "Emma Bonanno, Emily Johansen, Katia Krotova"
date: "10/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Research Question

Are there significant correlations between rural/suburban/urban characteristics, race, income, and majority county-level voting patterns in the 2020 presidential election? 


## Prior Research

Gimpel et. al (2020) find that urban–rural political party splits persist even after accounting for an array of individual-level characteristics, such as race, income and education. Hill et. al (2019) demonstrate that at the precinct level, local demographic changes and increasing diversity did not correlate to an increase in support for anti-immigration Republican candidates in the lead up to the 2016 presidential election. 


```{r, load packagaes and ACS, include = FALSE, quiet = TRUE}
library(tidyverse)
library(tidycensus)
library(readxl)
library(knitr)
library(tigris)
library(sf)
library(gridExtra)

vars_2017 <- load_variables(2017, "acs5")
```
## Data

Our sample population for this analysis is the full set of all counties across the United States (3,220 observations total). The data included in the analysis is:


* People per square mile (American Community Survey 2017)
* Median income (American Community Survey 2017)
* Population identifying as White only and Black / African-American only (American Community Survey 2017)
* Majority vote in the 2020 presidential election (MIT Election Data and Science Lab, 2018)
* Urban-Rural County classification (National Center for Health Statistics 2013)

Load ACS Data
```{r, quiet = TRUE, results= FALSE}
acs <- get_acs(geography = "county", 
                        year = 2017,
                        variables = c(total_pop = "B01003_001",
                                      med_inc = "B06011_001",
                                      Black = "B02001_003",
                                      white = "B02001_002"),
                        output = "wide",
                        geometry = TRUE)

areas <- counties() %>%
  st_set_geometry(NULL) %>%
  mutate(sq_miles = ALAND / 2589988.11) %>%
  select(GEOID, sq_miles)
```
Load suburban-rural classification
```{r}
CO_type <- read_xlsx(path = "data/NCHSURCodes2013.xlsx", 
                      sheet = "NCHSURCodes2013") %>%
  mutate(GEOID = case_when(str_length(as.character(`FIPS code`)) == 5 ~ 
                            as.character(`FIPS code`),
                          str_length(as.character(`FIPS code`)) == 4 ~
                            paste("0", `FIPS code`, sep=""),
                          TRUE ~ "unknown")) %>%
  mutate(type = case_when(`2013 code` == 1 ~ "Large central metro",
                          `2013 code` == 2 ~ "Large fringe metro",
                          `2013 code` == 3 ~ "Medium metro",
                          `2013 code` == 4 ~ "Small metro",
                          `2013 code` == 5 ~ "Micropolitan",
                          `2013 code` == 6 ~ "Non-core",
                          TRUE ~ "unknown")) %>%
  select(GEOID, type)
```

Load election result (Democrat/Republican) data 
```{r, quiet = TRUE, results = 'hide'}
election <- read_csv('data/countypres_2000-2020.csv') %>%
  filter(year == 2020) %>%
  filter(party == "REPUBLICAN") %>%
  rename(GEOID = county_fips) %>%
  group_by(GEOID) %>%
  summarize(candidatevotes = sum(candidatevotes),
            totalvotes = first(totalvotes)) %>%
  mutate(pct_GOP = (candidatevotes / totalvotes)*100) %>%
  select(GEOID, pct_GOP)
```

```{r}
election <- election %>%
   mutate(GEOID = as.character(GEOID))
```
Join datasets: 
```{r}
data <- left_join(acs, areas) %>%
  left_join(election) %>%
  left_join(CO_type) %>%
  mutate(pop_dens = total_popE / sq_miles) %>%
  select(GEOID, NAME, total_popE, pop_dens, med_incE, BlackE, whiteE, type, pct_GOP)

kable(head(data))
```
## Descriptive Statistics

# Continuous Variables

The continuous variable used in this research are population density, median income, population identifying as White-only, population identifying as Black or African American-only, and percentage of a county's population that voted Republican in the 2020 presidential election. 

Assignment 2:

For each continuous variable calculate:

1.The sample mean
2.The 95-percent confidence interval for the population mean
3.The sample standard deviation
4.The interquartile range
5.An illustration (e.g. a histogram) and description of the distribution.

# Calculations

```{r, the sample mean and the 95-percent confidence interval from the population mean by using one sample t-test}

medinc_t_test <- t.test(data$med_incE)
dens_t_test <- t.test(data$pop_dens)
black_t_test <- t.test(data$BlackE)
white_t_test <- t.test(data$whiteE)
GOP_t_test <- t.test(data$pct_GOP)
```

```{r, calculationg the median and the interquartile range using the quantile function}

medinc_quartiles <- quantile(data$med_incE, na.rm = TRUE)
dens_quartiles <- quantile(data$pop_dens, na.rm = TRUE)
black_quartiles <- quantile(data$BlackE, na.rm = TRUE)
white_quartiles <- quantile(data$whiteE, na.rm = TRUE)
GOP_quartiles <- quantile(data$pct_GOP, na.rm = TRUE)

```

```{r, calculationg standard deviation}

medinc_st_dev <- sd(data$med_incE, na.rm = TRUE)
dens_st_dev <- sd(data$pop_dens, na.rm = TRUE)
black_st_dev <- sd(data$BlackE, na.rm = TRUE)
white_st_dev <- sd(data$whiteE, na.rm = TRUE)
GOP_st_dev <- sd(data$pct_GOP, na.rm = TRUE)

```

```{r, generationg histogram for each variable}

medinc_hist <- ggplot(data) +
  geom_histogram(aes(x = med_incE),
                 bins = 30)

dens_hist <- ggplot(data) +
  geom_histogram(aes(x = pop_dens),
                 bins = 30) +
  scale_x_continuous(trans = "log")

black_hist <- ggplot(data) +
  geom_histogram(aes(x = BlackE),
                 bins = 30) +
   scale_x_continuous(trans = "log")

white_hist <- ggplot(data) +
  geom_histogram(aes(x = whiteE),
                 bins = 30)+
  scale_x_continuous(trans = "log")

GOP_hist <- ggplot(data) +
  geom_histogram(aes(x = pct_GOP),
                 bins = 30) +
  scale_x_continuous(trans = "log")


```


# Displaying Results

```{r, displaying results from the continous variables, warning=FALSE}

medinc_t_test
medinc_quartiles
medinc_st_dev
medinc_hist

```
```{r, creating formatted table to display the results above}

cont_summary <- tibble(
  Variable = c("Median income", 
               "Population density (people per square mile)",
               "Population identifying as Black or African-American only",
               "Population identifying as White only",
               "Percent who voted Republican"),
  `Sample mean` = c(medinc_t_test$estimate,
                    dens_t_test$estimate,
                    white_t_test$estimate,
                    black_t_test$estimate,
                    GOP_t_test$estimate),
  `Population mean (95% confidence) - low` = 
    c(medinc_t_test$conf.int[1],
      dens_t_test$conf.int[1],
       white_t_test$conf.int[1],
      black_t_test$conf.int[1],
      GOP_t_test$conf.int[1]),
  `Population mean (95% confidence) - high` =
    c(medinc_t_test$conf.int[2],
      dens_t_test$conf.int[2],
      white_t_test$conf.int[2],
      black_t_test$conf.int[2],
      GOP_t_test$conf.int[2]),
  Median = c(medinc_quartiles[3],
             dens_quartiles[3],
             white_quartiles[3],
             black_quartiles[3],
             GOP_quartiles[3]),
  `Interquartile range` = c(medinc_quartiles[4] - medinc_quartiles[2],
                            dens_quartiles[4] - dens_quartiles[2],
                            white_quartiles[4] - white_quartiles[2],
                            black_quartiles[4] - black_quartiles[2],
                            GOP_quartiles[4] - GOP_quartiles[2]),
  `Standard deviation` = c(medinc_st_dev,
                          dens_st_dev,
                          white_st_dev,
                          black_st_dev,
                          GOP_st_dev))

kable(cont_summary, digits = 0)


```
```{r, row of historgrams for the continous variables above}

pretty_medinc_hist <- medinc_hist +
  theme_bw() +
  scale_x_continuous(name = "Median income") +
  scale_y_continuous(name = "Number of counties") +
  theme(axis.text.x = element_text(angle = 90))

pretty_GOP_hist <- GOP_hist +
  theme_bw() +
  scale_x_continuous(name = "% of county residents who voted Republican") +
  scale_y_continuous(name = "Number of counties") +
  theme(axis.text.x = element_text(angle = 90))

pretty_dens_hist <- dens_hist +
  theme_bw() + 
  scale_x_continuous(name = "Population density\n(residents per square mile)",
                     trans = "log",
                     breaks = c(0.1, 1, 10, 100, 1000, 10000),
                     labels = c("0.1", "1", "10", "100", "1000", "10,000")) +
  scale_y_continuous(name = "Number of counties") +
  theme(axis.text.x = element_text(angle = 90))

pretty_white_hist = white_hist +
  theme_bw() +
  scale_x_continuous(name = "Population identifying as White only",
                     trans = "log",
                     breaks = seq(0, 0.3, by=.05),
                     labels = seq(0, 300, by = 50)) +
  scale_y_continuous(name = "Number of counties") +
  theme(axis.text.x = element_text(angle = 90)) 

pretty_black_hist = black_hist +
  theme_bw() +
  scale_x_continuous(name = "Population identifying as Black or African-American only",
                     trans = "log",
                     breaks = seq(0, 0.3, by=.05),
                     labels = seq(0, 300, by = 50)) +
  scale_y_continuous(name = "Number of counties") +
  theme(axis.text.x = element_text(angle = 90))


grid.arrange(pretty_medinc_hist, pretty_dens_hist, pretty_white_hist, pretty_black_hist, pretty_GOP_hist,
             ncol = 3)


```

## Categorical Variables

The categorical variable used in this analysis is:

* The county type (non-core, micropolitan, metropolitan, etc), based on the NCHS classification.

# Calculations

```{r,  using a one sample t-test to get the 95-percent confidence interval for the proportion of the sample in each category}


pct_large_metro <- t.test(data$type == "Large central metro")
pct_fringe_metro <- t.test(data$type == "Large fringe metro")
pct_med_metro <- t.test(data$type == "Medium metro")
pct_small_metro <- t.test(data$type == "Small metro")
pct_micro <- t.test(data$type == "Micropolitan")
pct_rural <- t.test(data$type == "Non-core")

```

```{r, displaying results - county type}

cat_summary_type <- tibble(`County type` = 
                              c("Large central metro",
                                "Large fringe metro",
                                "Medium metro",
                                "Small metro",
                                "Micropolitan",
                                "Non-core"),
                            `Sample proportion` = 
                              c(pct_large_metro$estimate * 100,
                                pct_fringe_metro$estimate * 100,
                                pct_med_metro$estimate * 100,
                                pct_small_metro$estimate * 100,
                                pct_micro$estimate * 100,
                                pct_rural$estimate * 100),
                            `95-percent confidence - low` = 
                              c(pct_large_metro$conf.int[1] * 100,
                                pct_fringe_metro$conf.int[1] * 100,
                                pct_med_metro$conf.int[1] * 100,
                                pct_small_metro$conf.int[1] * 100,
                                pct_micro$conf.int[1] * 100,
                                pct_rural$conf.int[1] * 100),
                            `95-percent confidence - high` = 
                              c(pct_large_metro$conf.int[2] * 100,
                                pct_fringe_metro$conf.int[2] * 100,
                                pct_med_metro$conf.int[2] * 100,
                                pct_small_metro$conf.int[2] * 100,
                                pct_micro$conf.int[2] * 100,
                                pct_rural$conf.int[2] * 100))

kable(cat_summary_type, digits = 0)
```

```{r, bar charts for county type}

ggplot(cat_summary_type) +
  geom_bar(aes(x = `County type`, 
               y = `Sample proportion`),
           stat = "identity") +
  geom_errorbar(aes(x = `County type`, 
               y = `Sample proportion`,
               ymin = `95-percent confidence - low`,
               ymax = `95-percent confidence - high`),
           stat = "identity") +
  scale_y_continuous(name = "Percent of counties",
                     breaks = c(0, 10, 20, 30, 40),
                     labels = c("0", "10%", "20%", "30%", "40%")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90))

```



# References

Gimpel, J.G., N. Lovin, B. Moy, & A. Reeves (2020). "The Urban–Rural Gulf in American Political Behavior". Political Behavior, 42, 1343-1368.

Hill, Seth J.,  Daniel J. Hopkins, Gregory A. Huber (2019). "Local demographic changes and US presidential voting, 2012 to 2016". Proceedings of the National Academy of Arts and Sciences, December 10, 2019 116 (50) 25023-25028. 





